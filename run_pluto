#
#!/bin/bash

# Do not Change this line directly.
# Please use the command ./set_pluto to configure the Pluto IP address if required. 
# This will ensure that all necessary files are updated, including this one. 

$HOME/Langstone/Screen_Message "Langstone Loading"

export PLUTO_IP=pluto.local

#Create command pipe
if test -e /tmp/langstoneTRx ;then
rm /tmp/langstoneTRx
fi
mkfifo /tmp/langstoneTRx

#Test to see if the flowgraph is already running
if !(ps -ax |grep -v grep| grep -q Lang_TRX_Pluto.py) then
   sudo amixer -c 2  cset numid=6 100%  > /dev/null 2>&1
   sudo amixer -c 2 cset numid=8 50%  > /dev/null 2>&1
   $HOME/Langstone/Screen_Message "Langstone Loading" "Checking Pluto"
   
   retry=0
   until [ ${retry} -ge 4 ]
   do
      (ping -c1 $PLUTO_IP 2>/dev/null |grep -q received) && break
       retry=$[${retry}+1]
       sleep 1
   done

   #Check if Pluto failed to respond

   if [ ${retry} -ge 4 ]; then
      clear
      $HOME/Langstone/Screen_Message "Pluto Failed to Respond" "Check Power" "And Connections"
      sleep 5
      exit 0
   fi

   # Check if Pluto was rebooting and was slow to respond

   if [ ${retry} -ge 1 ]; then
      sleep 5
   fi

   $HOME/Langstone/Screen_Message "Langstone Loading"

# Start the GUI (which will also start the GNURadio module

   $HOME/Langstone/GUI_Pluto > /tmp/LangstoneGUI_Pluto.log 2>&1
   # Send a reboot command to Pluto after GUI Exits
   ssh-keygen -f "$HOME/.ssh/known_hosts" -R $PLUTO_IP >/dev/null 2>&1
   timeout 2 sshpass -p analog ssh -o StrictHostKeyChecking=no root@$PLUTO_IP 'PATH=/bin:/sbin:/usr/bin;reboot'  >/dev/null 2>&1

else
   echo Langstone is already running. Use ./stop first.
   sleep 5
fi

